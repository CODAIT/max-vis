<html>
  <head>
    <meta charset="utf-8">
    <title>max-vis</title>
    <style>
      body > div {
        margin: 20px;
      }
      h1 > span {
        font-size: 0.65em;
        font-weight: lighter;
      }
      .wrappingDiv {
        padding: 10px;
      }
      #imageWrapper {
        position: relative;
        display: inline-block;
        min-width: 600px;
        vertical-align: top;
      }
      #theImage {
        z-index: 1;
        position: absolute;
        left: 0px;
        top: 0px;
        width: 512px;
      }
      #message {
        position: relative;
        display: inline-block;
      }
      #maxVisOutput > img {
        display: block;
        padding-bottom: 10px;
      }
    </style>
  </head>
  <script>
    let theImage

    function disableElements (disable) {
      if (disable) {
        document.getElementById('maxVisOutput').innerHTML = ''
        document.getElementById('message').innerHTML = ''

        if (theImage && theImage.width && theImage.nextElementSibling) {
          theImage.nextElementSibling.getContext('2d').clearRect(0, 0, theImage.width, theImage.height)
        }

        document.getElementById('theImage').n
        document.getElementById('uploadImage').setAttribute('disabled', true)
        document.getElementById('modelrun').setAttribute('disabled', true)
      } else {
        document.getElementById('uploadImage').removeAttribute('disabled')
        document.getElementById('modelrun').removeAttribute('disabled')
      }
    }
    function message (msg) {
      const node = document.createElement('div')
      node.innerText = msg
      document.getElementById('message').appendChild(node)
    }

    function loadImage (input) {
      if (input.files && input.files[0]) {
        disableElements(true)

        let reader = new FileReader()
        reader.onload = function (e) {
          theImage = document.getElementById('theImage')
          theImage.src = reader.result
          theImage.style.display = ''
          disableElements(false)
        }

        reader.readAsDataURL(input.files[0])
      }
    }

    function runPredictionThenVis () {
      if (!theImage) {
        message('please upload an image')
      } else {
        disableElements(true)
        message('running prediction...')
        const visType = document.getElementById('maxVisType').value
        imageSegmenter
          .predict(theImage)
          .then(prediction => {
            theImage.parentNode.style.height = theImage.height
            if (visType === 'overlay') {
              message(`calling maxVis.overlay...`)
              // overlay over existing image
              maxVis.overlay(prediction, theImage)
            } else if (visType === 'annotate') {
              // generate new annoted image
              maxVis.annotate(prediction, theImage)
                .then(annotatedImage => {
                  // the returned 'annotatedImage' is a Blob
                  let img = document.createElement('img')
                  img.width = theImage.width
                  img.src = URL.createObjectURL(annotatedImage)
                  document.getElementById('maxVisOutput').appendChild(img)
                })
            } else if (visType === 'extract') {
              // extract prediction from image
              maxVis.extract(prediction, theImage)
                .then(response => {
                  response.forEach(imgInfo => {
                    let url = URL.createObjectURL(imgInfo.image)
                    let newImg = document.createElement('img')
                    newImg.src = url
                    newImg.setAttribute('alt', imgInfo.label)
                    document.getElementById('maxVisOutput').appendChild(newImg)
                  })
                })
            }
          })
          .catch(message)
          .then(() => {
            message('done')
            disableElements(false)
          })
      }
    }
  </script>
  <body>
    <div>
      <h1>max-vis // <span>using image-segmenter</span></h1>
      <div class="wrappingDiv">
        <select id="maxVisType">
          <option value="overlay">overlay</option>
          <option value="annotate">annotate</option>
          <option value="extract">extract</option>
        </select>
        <input id="uploadImage" type="file" name="filename" accept="image/gif, image/jpeg, image/png" onchange="loadImage(this);">
        <button id="modelrun" onclick="runPredictionThenVis();">run</button>
      </div>
      
      <div class="wrappingDiv">
        <div id="imagewrapper">
          <img id="theImage" src="#" style="display: none;"/>
        </div>
        <div id="message"></div>
      </div>
      <div id="maxVisOutput" class="wrappingDiv">
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@codait/max-image-segmenter"></script>
    <script src="/dist/max-vis.js"></script>
  </body>
</html>
